# Example configuration for DataHub Remote Ingestion Executor on AWS ECS EC2

# Cluster Configuration
cluster_name = "datahub-remote-executor-ec2"

# DataHub Configuration
datahub = {
  url                              = "https://your-company.acryl.io/gms"
  executor_pool_id                 = "ecs-ec2-executor-pool"
  executor_ingestions_workers      = 4
  executor_monitors_workers        = 10
  executor_ingestions_poll_interval = 5
}

# Service Configuration
service_name   = "datahub-remote-executor-ec2"
desired_count  = 1
launch_type    = "EC2"

# Resource Configuration for EC2 (lower values since instance provides resources)
cpu    = 512   # Task-level CPU units
memory = 1024  # Task-level memory in MB

# EC2-specific Configuration
ec2_config = {
  # Use existing private subnets with NAT Gateway connectivity
  private_subnet_ids = [
    "subnet-xxxxxxxx",  # Replace with your private subnet ID (AZ 1)
    "subnet-yyyyyyyy",  # Replace with your private subnet ID (AZ 2)
    "subnet-zzzzzzzz",  # Replace with your private subnet ID (AZ 3)
  ]
  instance_type = "t3.large"
}

# Network Configuration - uses existing private subnets with NAT Gateway connectivity
# No need to specify subnet_ids or assign_public_ip for EC2 launch type
# The module uses the private subnets specified in ec2_config.private_subnet_ids

# Security Group Rules (applied to ECS tasks)
security_group_rules = {
  egress_all = {
    type        = "egress"
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# IAM Roles
create_tasks_iam_role     = true
create_task_exec_iam_role = true

# Secrets Manager - Replace with your secret ARN
# Create your secret via:
# `aws secretsmanager create-secret --name "datahub-access-token" --description "DataHub GMS access token for remote executor" --secret-string "<DATAHUB_TOKEN>" --region <AWS_REGION>`
task_exec_secret_arns = [
  "arn:aws:secretsmanager:us-west-2:123456789012:secret:datahub-access-token-xxxxxx",
]

secrets = [
  {
    name      = "DATAHUB_GMS_TOKEN"
    valueFrom = "arn:aws:secretsmanager:us-west-2:123456789012:secret:datahub-access-token-xxxxxx"
  }
]

# CloudWatch Logging
enable_cloudwatch_logging   = true
create_cloudwatch_log_group = true

# ECS Exec
enable_execute_command = true

# Environment Variables (optional)
environment = [
  {
    name  = "DATAHUB_DEBUG"
    value = "false"
  },
  {
    name  = "CELERY_LOG_LEVEL"
    value = "INFO"
  },
  {
    name  = "PYTHONUNBUFFERED"
    value = "1"
  }
]

# Tags
tags = {
  Environment = "production"
  Project     = "datahub-remote-executor"
  ManagedBy   = "terraform"
}
